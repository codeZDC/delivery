var deliveryType = $("#deliveryType").val(); // 获取汇交类型(12个中的一个)
var deliverySubmit = false; // 防止重复提交
jQuery(function($) {
	// 更改页面头名字
	$("#headerTitle").html(templateName[deliveryType]);

	// 初始化下拉菜单的选项
	$("select").each(
			function() {
				var select = $(this);
				if (select.attr('type')) {// 如果有type这个属性
					var options = dropArr[select.attr('type')];
					for ( var i in options) {
						select.append("<option value='"
								+ (options[i] == '请选择' ? "" : options[i])
								+ "'>" + options[i] + "</option>");
					}

					// 给自定义按钮添加事件
					select.on('change', function() {
						if (select.val() == '自定义') {
							// 把旁边的input按钮显示出来
							select.next().removeClass('hide').val('');
						} else {
							var input = select.next();
							input.addClass('hide');
							// 清空input的值
							input.val(select.val());
						}
					});
				}
			});

	// 添加鼠标上移弹出提示功能
	$('[data-rel=popover]').popover({
		container : 'body'
	});

	// 文件上传 控件

	$('#shpFile').ace_file_input({
		style : 'well',
		btn_choose : '点这里选择文件  或者拖放文件到这里 只接受.shp文件',
		btn_change : null,
		no_icon : 'ace-icon fa fa-cloud-upload',
		droppable : true,
		// maxSize: 110000,//文件允许的最大值 bytes
		allowExt : [ "shp" ],// 允许的后缀名
		// allowMime: ["image/jpg", "image/jpeg", "image/png", "image/gif"],
		thumbnail : 'small'// large | fit
		// ,icon_remove:null//set null, to hide remove/reset button
		/**
		 * ,before_change:function(files, dropped) { //Check an example below
		 * //or examples/file-upload.html return true; }
		 */
		/**
		 * ,before_remove : function() { return true; }
		 */
		,
		preview_error : function(filename, error_code) {
			// name of the file that failed
			// error_code values
			// 1 = 'FILE_LOAD_FAILED',
			// 2 = 'IMAGE_LOAD_FAILED',
			// 3 = 'THUMBNAIL_FAILED'
			// alert(error_code);
		}

	}).on('change', function() {
		// console.log($(this).data('ace_input_files'));
		// console.log($(this).data('ace_input_method'));
	}).on('file.error.ace', function(ev, info) {
		if (info.error_count['ext'])
			alert('文件格式不允许，请选择一个.shp文件');
		// if(info.error_count['size']) alert('文件过大，超过了 100KB');
	});

	$('#qualityFile').ace_file_input({
		style : 'well',
		btn_choose : '点这里选择文件  或者拖放文件到这里 只接受.png或者jpg文件',
		btn_change : null,
		no_icon : 'ace-icon fa fa-cloud-upload',
		droppable : true,
		// maxSize: 110000,//文件允许的最大值 bytes
		allowExt : [ "png", "jpg" ],// 允许的后缀名
		allowMime : [ "image/jpg", "image/jpeg", "image/png", "image/gif" ],
		thumbnail : 'small'// large | fit
		,
		preview_error : function(filename, error_code) {
			// name of the file that failed
			// error_code values
			// 1 = 'FILE_LOAD_FAILED',
			// 2 = 'IMAGE_LOAD_FAILED',
			// 3 = 'THUMBNAIL_FAILED'
			// alert(error_code);
		}

	}).on('change', function() {
		// console.log($(this).data('ace_input_files'));
		// console.log($(this).data('ace_input_method'));
	}).on('file.error.ace', function(ev, info) {
		if (info.error_count['ext'] || info.error_count['mime'])
			alert('文件格式不允许，请选择一个允许的图片,png或者jpg');
		// if(info.error_count['size']) alert('文件过大，超过了 100KB');
	});

	/**
	 * 添加点击查看弹出地图界面
	 */
	$("#viewMap").on('click', function() {
		top.fullScreenShow();// 显示地图
	});
	/**
	 * 查看图片按钮
	 */
	$("#viewImgs").on('click', function() {
		top.viewImg();// 显示地图
	});

	// 提交表单
	$('.submitForm').click(function() {
		// deliveryType
		// 验证成功后进行提交
		var handle = $('#handle').val();
		var url = contextPath + deliveryType + '/' +handle;
		if(handle == 'edit') {
			$('form select').each(function(){
				$(this).removeAttr('name');
			});
		}
		
		if (!deliverySubmit) {
			deliverySubmit = true;
			$.post(url, $(this).parents('form').serialize(), function(res) {
				if (res.success) {
					alert(res.message);
					deliverySubmit = false;
					location = contextPath + 'page/deliver/mainView';
				} else {
					alert('网络错误,请联系管理员!');
				}
			}, 'json');
		} else {
			alert('正在提交中...');
		}
	});
	
	// 重置表单
	$('.resetForm').click(function() {
		if($('#handle').val() == 'edit')
			loadEditForm();
		else
			$(this).parents('form')[0].reset();
	});

});
