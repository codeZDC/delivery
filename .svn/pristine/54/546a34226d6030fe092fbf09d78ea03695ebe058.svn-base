jQuery(function($){
	//当文档加载完成,获取省市县信息,,
	getPcd();//获取用户下的省市县
	$('#myTab').on('click','.dropdown-info>li',function(){
		$(this).attr('zoneCode');
		//改变title
		$('#cityName').text($(this).text());
	});
});

function getPcd(){
	$.getJSON(contextPath+'zone/getPcd',function(res){
		var data = res.data;
		if(!data){
			alert('网络错误,请联系管理员');return;
		}
		if(data[0].zoneCode.length==6){//县级审批员
			buildDistrct(data);
			//精确查询加载表格
			loadTable(data[0].zoneCode);
		}else{//省级市级审批
			buildCitys(data);
			if(data.length==1) $('#grade').text('市级审批');
			else $('#grade').text('省级审批');
			//模糊查询加载表格
			loadTable(data[0].zoneCode,0);
		}
	});
}
function buildDistrct(data){
	var li = $('<li>').addClass('dropdown active'); 
	var a  =  $('<a aria-expanded="false"> '+ data[0].zoneName+' </a>');
	li.append(a).appendTo($('#myTab').empty());
	$('#cityName').text(data[0].zoneName);
	$('#grade').text('县级审批');
}
function buildCitys(data){
	var a , 
	ul,
	li = $('<li>').addClass('dropdown'), 
	myTab = $('#myTab').empty();
	$.each(data,function(index,per){
		a =  $('<a data-toggle="dropdown" class="dropdown-toggle" href="#" aria-expanded="false"> '+
			 per.zoneName+' &nbsp; <i class="ace-icon fa fa-caret-down bigger-110 width-auto"></i></a>');
		ul = $('<ul>').addClass('dropdown-menu dropdown-info');
		$.each(per.citys,function(ind,pe){
			$('<li>').attr('zoneCode',pe.zoneCode).append($('<a>').text(pe.zoneName)).appendTo(ul);
		});
		li.clone().addClass(index==0?'active':'').append(a).append(ul).appendTo(myTab);
	});
}

//获取管辖类的用户信息构建表格
//type=0表示初始化表格,后端采用模糊查询,,不为0精确查找
function loadTable(code,type,pageNum){	
	var zdc = "zzzzdddccc";
	var pageSize = 8;
	$.getJSON(contextPath + "delivery/getCompanies",{pageNum:pageNum,pageSize:pageSize,deliveryCode:code,examineType:type,zdc},function(res){
			buildTable(res.rows);
			initPaginationBar(res.total,pageSize,pageNum,function(currentPage){loadTable(code,type,currentPage);});
	});
}

function buildTable(data){
	var index,year,unitName,span,deliveryStatus,remarks,
	handle = $('<td>').append('<div class="hidden-sm hidden-xs action-buttons">\
					<a class="purple editData" href="#" data-rel="tooltip"  title="查看" onclick="top.viewDeliverList()"> <i\
					class="ace-icon fa fa-eye bigger-130"></i></a> \
				<a class="green editData" href="#" data-rel="tooltip"  title="同意"> <i\
					class="ace-icon fa fa-check bigger-130"></i></a> \
				<a\
					class="red removeData" href="#" data-rel="tooltip"  title="不同意"> <i\
					class="ace-icon fa fa-times bigger-130"></i></a>\
			</div>'),
	table = $('.table-striped.table-bordered tbody').empty();
	$.each(data,function(ind,per){
		index = $('<td>').text(ind+1);
		year = $('<td>').text(per.deliveryYear);
		unitName = $('<td>').text(per.unitName);
		if(per.deliveryStatus==0)
			 span = $('<span class="label">').addClass('info').text('零汇交');
		else if(per.deliveryStatus==1)
			span = $('<span class="label">').addClass('success').text('已汇交');
		else 
			span = span = $('<span class="label">').text('未汇交');
		deliveryStatus = $('<td>').append(span);
		remarks = $('<td>').text(per.remarks);
		$('<tr>').append(index).append(year).append(unitName).append(deliveryStatus)
		.append(remarks).append(handle.clone()).appendTo(table);
	});
	
}
