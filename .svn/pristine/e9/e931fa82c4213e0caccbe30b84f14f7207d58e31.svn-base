jQuery(function($){
	// 获取用户汇交信息
	getDeliveries();
	//设置时间
	$('.dateSpan').text(formatDate(new Date()));
});

function getDeliveries(){
	// 获取汇交清单
	$.getJSON(contextPath+'delivery/getDeliveries',{},function(res){
		console.log(res);
		// $('#form-field-9').val(res.msg);
		showResult(res);
	});
}

// 根据状态来显示审核结果
function showResult(res){
	var status = res.msg;
	if(status == 250){
		$('#noDelivery').show();
	}else{
		$('#deliverList2').show();
		buildTable(res);
	}
	
	
	if(status == 199){// 草稿
		
	}else if(status == 250){
		// 空汇交项目,相应模块的显示
		// $('#noDelivery').toggle();
	}else if(status == 208){// 审核通过
		
		showExaminieMark('examinie-pass.png');
	}else if(status == 202 || status == 204){// 审核不通过
		showExaminieMark('examinie-decline.png');
	}else{// 审核中
		showExaminieMark('examining.png');
	}
	
}

function buildTable(res){
	var rows = res.map.rows;
	//设置项目个数显示框
	$('#deliveryCount').text(rows.length);
	var index,xmmc,type,iscopy,remarks,
	handle = $('<td>\
				<div class="hidden-sm hidden-xs action-buttons">\
				<a class="green editData" href="#"> <i\
					class="ace-icon fa fa-pencil bigger-130"></i></a> <a\
					class="red removeData" href="#"> <i\
					class="ace-icon fa fa-trash-o bigger-130"></i></a>\
				</div>\
				</td>'),
	table = $('#deliveries_table tbody').empty();
	$.each(rows,function(ind,per){
		index = $('<td>').append(ind+1);
		xmmc = $('<td>').append($('<a href="#">').text(per.xmmc));
		type = $('<td>').text(per.type);
		iscopy = $('<td>').text(per.iscopy==1?'是':'否');
		remarks = $('<td>').text(per.remarks);
		$('<tr>').attr('id',per.id).attr('type',per.type).append(index).append(xmmc).append(type)
			.append(iscopy).append(remarks).append(handle.clone()).appendTo(table);
	});
}

$('#deliveries_table').on('click','.editData',function(){
	var id = $(this).parents('tr').attr('id');
	var type = $(this).parents('tr').attr('type');
	location = contextPath + 'page/12templatesEdit/mainView?id='+id+'&type='+type;
});
$('#deliveries_table').on('click','.removeData',function(){
	var id = $(this).parents('tr').attr('id');
	var type = $(this).parents('tr').attr('type');
	showConfirm(function(){
		$.getJSON(contextPath + type+'/del',{ids:[id]},function(res){
			if(res.success)
				location.reload();
			else
				alert('网络错误,请联系管理员!');
		});
	});
});
//提交审核
$('.submitDelivery').click(function(){
	//校验表单,,就不校验
	
});



// 显示审核结果标签
function showExaminieMark(mark){
	
	var examinieMark = $("#examinieMark");
	examinieMark.show();
	examinieMark.attr('src',examinieMark.attr('src-rooPath') + mark);
}


$("#toAdd").on('click',function(){
	$("#listTabContent").removeClass('active');// 关闭清单tab
	$("#addTanContent").addClass('active');// 打开添加tab
});
